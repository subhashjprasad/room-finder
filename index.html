<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Berkeley Room Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="/static/buildings.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="map"></div>
    <script>
        async function initializeMap() {
            const accessToken = "pk.eyJ1Ijoic3ViaGFzaGpwcmFzYWQiLCJhIjoiY2x3Ymg1ZWNhMG5jZTJtbzB6ZWhncm5udyJ9.MavuHjcJJ-oXI09j5_fzOQ";

            const map = L.map('map', { zoomControl: false, doubleClickZoom: false }).setView([37.8719, -122.2585], 17);

            let currentTileLayer = 'light';
            let borderColor = '#444';
            let borderColorHover = '#000';
            let highlightedLayer = null;
            let permanentlyHighlightedLayer = null;
            let geojson = null;
            let markers = [];

            function updateTileBackgrounds() {
                const tiles = document.querySelectorAll('.leaflet-tile');
                tiles.forEach(tile => {
                    tile.classList.remove('light', 'dark');
                    tile.classList.add(currentTileLayer);
                });
            }

            function toggleTileLayer() {
                if (currentTileLayer === 'dark') {
                    tileLayer.setUrl(`https://api.mapbox.com/styles/v1/mapbox/light-v11/tiles/{z}/{x}/{y}?access_token=${accessToken}`);
                    currentTileLayer = 'light';
                    borderColor = '#444';
                    borderColorHover = '#000';
                } else {
                    tileLayer.setUrl(`https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/{z}/{x}/{y}?access_token=${accessToken}`);
                    currentTileLayer = 'dark';
                    borderColor = '#bbb';
                    borderColorHover = '#fff';
                }
                updateTileBackgrounds();
                map.eachLayer(function(layer) {
                    if (layer instanceof L.Marker) {
                        updateLabelFontSize(layer);
                    }
                });

                if (geojson) {
                    geojson.eachLayer(function(layer) {
                        geojson.resetStyle(layer);
                    });
                }
            }

            function updateLabelFontSize(marker) {
                const zoom = map.getZoom();
                const label = marker.getElement().querySelector('.label-text');

                if (currentTileLayer === 'light') {
                    label.style.color = 'black';
                } else {
                    label.style.color = 'white';
                }

                label.style.fontSize = `${10 + 3 * (zoom - 17)}pt`;

                const labelWidth = label.offsetWidth;
                const labelHeight = label.offsetHeight;
                const markerWidth = marker._icon.offsetWidth;
                const markerHeight = marker._icon.offsetHeight;

                label.style.marginLeft = `${((markerWidth - labelWidth) / 2) + (zoom - 17) / 2}px`; 
                label.style.marginTop = `${(markerHeight - labelHeight) / 2}px`;
            }

            let tileLayer = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/light-v11/tiles/{z}/{x}/{y}@2x?access_token=${accessToken}`, {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                    'Imagery &copy; <a href="https://www.mapbox.com/">Mapbox</a>, ' + 'Developed by <a href="https://www.linkedin.com/in/subhash-j-prasad/">Subhash Prasad</a>',
                maxZoom: 25,
                minZoom: 14,
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map);

            tileLayer.on('tileload', updateTileBackgrounds);
            tileLayer.on('tileerror', updateTileBackgrounds);

            const info = L.control({ position: 'topright' });

            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                return this._div;
            };

            info.update = function (props, clicked = false) {
                this._div.innerHTML = '<h4>Building Information</h4>' + (props ?
                    '<b>' + props.name + '</b><br />' + (clicked ? props.rooms.join('<br>') : props.numRooms + ' available room' + (props.numRooms === 1 ? '' : 's'))
                    : 'Hover over a building');
            };

            info.addTo(map);

            function highlightFeature(e) {
                if (e.target !== permanentlyHighlightedLayer) {
                    const layer = e.target;
                    layer.setStyle({
                        weight: 2,
                        color: borderColorHover,
                        dashArray: '',
                        fillOpacity: 1.0
                    });

                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        layer.bringToFront();
                    }

                    info.update(layer.feature.properties);
                    highlightedLayer = layer;
                }
            }

            function resetHighlight(e) {
                if (highlightedLayer && highlightedLayer !== permanentlyHighlightedLayer) {
                    geojson.resetStyle(highlightedLayer);
                    highlightedLayer = null;
                }
                if (!permanentlyHighlightedLayer) {
                    info.update();
                } else {
                    info.update(permanentlyHighlightedLayer.feature.properties, true);
                }
            }

            function permanentHighlightFeature(e) {
                if (permanentlyHighlightedLayer) {
                    geojson.resetStyle(permanentlyHighlightedLayer);
                }
                permanentlyHighlightedLayer = e.target;
                permanentlyHighlightedLayer.setStyle({
                    weight: 2,
                    color: borderColorHover,
                    dashArray: '',
                    fillOpacity: 1.0
                });

                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    permanentlyHighlightedLayer.bringToFront();
                }

                map.setView(permanentlyHighlightedLayer.feature.properties.center, 19);
                info.update(permanentlyHighlightedLayer.feature.properties, true);
            }

            function onEachFeature(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: permanentHighlightFeature
                });
            }

            map.on('click', function (e) {
                if (!e.originalEvent.target.closest('.leaflet-interactive')) {
                    if (permanentlyHighlightedLayer) {
                        geojson.resetStyle(permanentlyHighlightedLayer);
                        info.update();
                        permanentlyHighlightedLayer = null;
                    }
                }
            });

            async function fetchData(day, time, duration) {
                let response = await fetch('/static/data.json');
                let data = await response.json();

                let intervals = [];
                const daysOfWeek = ['M', 'TU', 'W', 'TH', 'F', 'SA', 'SU'];
                let dayIndex = daysOfWeek.indexOf(day);

                for (let i = 0; i < duration * 2; i++) {
                    let intervalTime = time + (i * 0.5);
                    let intervalDay = day;

                    if (intervalTime >= 24) {
                        intervalTime -= 24;
                        dayIndex = (dayIndex + 1) % 7;
                        intervalDay = daysOfWeek[dayIndex];
                    }

                    intervals.push({ day: intervalDay, time: intervalTime });
                }

                let availableRooms = {};
                let roomAvailability = {};

                intervals.forEach(interval => {
                    let matchedData = data.find(entry => entry.day === interval.day && entry.time === interval.time);
                    if (matchedData) {
                        Object.keys(matchedData.data).forEach(building => {
                            if (!roomAvailability[building]) {
                                roomAvailability[building] = {};
                            }
                            matchedData.data[building].forEach(room => {
                                if (!roomAvailability[building][room]) {
                                    roomAvailability[building][room] = 0;
                                }
                                roomAvailability[building][room]++;
                            });
                        });
                    }
                });

                Object.keys(roomAvailability).forEach(building => {
                    Object.keys(roomAvailability[building]).forEach(room => {
                        if (roomAvailability[building][room] === intervals.length) {
                            if (!availableRooms[building]) {
                                availableRooms[building] = [];
                            }
                            availableRooms[building].push(room);
                        }
                    });
                });

                if (geojson) {
                    map.removeLayer(geojson);
                }
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];

                buildings.forEach(building => {
                    building.properties.rooms = availableRooms[building.properties.name] || [];
                    building.properties.numRooms = building.properties.rooms.length;

                    const label = L.marker(building.properties.center, {
                        icon: L.divIcon({
                            className: 'label',
                            html: `<div class="label-text">${building.properties.numRooms}</div>`,
                            iconSize: [0, 0]
                        })
                    }).addTo(map);

                    updateLabelFontSize(label);

                    const labelTextElement = label.getElement().querySelector('.label-text');
                    labelTextElement.style.pointerEvents = 'none';

                    label.on('add', function() {
                        updateLabelFontSize(label);
                    });

                    markers.push(label);
                });

                map.on('zoom', function() {
                    markers.forEach(marker => updateLabelFontSize(marker));
                });

                geojson = L.geoJson(buildings, {
                    style: function (feature) {
                        return {
                            weight: 2,
                            opacity: 1,
                            color: borderColor,
                            dashArray: '3',
                            fillOpacity: 0.7,
                            fillColor: '#fff'
                        };
                    },
                    onEachFeature: onEachFeature
                }).addTo(map);

                info.update();
            }

            L.control.zoom({
                position: 'topright'
            }).addTo(map);

            fetchData('M', 8.0, 1.0);

            document.getElementById('timeForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const day = document.getElementById('day').value;
                const time = parseFloat(document.getElementById('time').value);
                const duration = parseFloat(document.getElementById('duration').value);
                fetchData(day, time, duration);
            });

            document.getElementById('toggleButton').addEventListener('click', toggleTileLayer);
        }

        initializeMap();

        </script>
    </body>
</html> 
